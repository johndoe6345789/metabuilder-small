# Phase 8: Redis Configuration for Celery Broker & Result Backend
# Email Client Implementation

# ============================================================================
# NETWORK & PORT CONFIGURATION
# ============================================================================

# Redis port (default 6379)
port 6379

# Bind to all interfaces (can be restricted to specific IP in production)
bind 0.0.0.0

# TCP backlog - connection queue length
tcp-backlog 511

# TCP keepalive
tcp-keepalive 300

# ============================================================================
# GENERAL CONFIGURATION
# ============================================================================

# Daemonize: off for Docker container (keep in foreground)
daemonize no

# Supervised: no for Docker (use systemd is not available in container)
supervised no

# PID file (not needed in Docker)
# pidfile /var/run/redis.pid

# Log level: notice (informational, normal)
loglevel notice

# Log to stdout in Docker
logfile ""

# Number of databases (default: 16)
databases 16

# ============================================================================
# AUTHENTICATION & SECURITY
# ============================================================================

# Require authentication password
# This can be overridden at runtime via environment variable
requirepass ${REDIS_PASSWORD:-redis_default_password_change_me}

# ACL configuration file (Redis 6+)
# aclfile /usr/local/etc/redis/acl.conf

# ============================================================================
# MEMORY MANAGEMENT
# ============================================================================

# Memory limit: 512MB for email client use
maxmemory 512mb

# Memory eviction policy when max memory is reached:
# - allkeys-lru: Remove any key using LRU eviction (best for caching)
# - volatile-lru: Only evict keys with TTL using LRU
# - allkeys-lfu: Remove any key using LFU eviction
# - volatile-lfu: Only evict keys with TTL using LFU
# - allkeys-random: Remove random keys
# - volatile-random: Only evict keys with TTL (random)
# - volatile-ttl: Evict closest-to-expire TTL keys
# - noeviction: Return error when limit reached (recommended for essential data)
maxmemory-policy allkeys-lru

# Memory sampling size for eviction (higher = more accurate but slower)
maxmemory-samples 5

# ============================================================================
# PERSISTENCE
# ============================================================================

# RDB (snapshot) persistence
# Save the DB on disk:
# save <seconds> <changes>
# Will save the DB if both the given number of seconds and number of write
# operations against the DB occurred.

# Default snapshots:
save 900 1      # Save after 900 sec (15 min) if at least 1 key changed
save 300 10     # Save after 300 sec (5 min) if at least 10 keys changed
save 60 10000   # Save after 60 sec if at least 10000 keys changed

# Disable RDB snapshots if you prefer AOF only
# save ""

# Compress string objects using LZF when dump .rdb databases
rdbcompression yes

# Checksum RDB file integrity
rdbchecksum yes

# RDB file name
dbfilename dump.rdb

# Working directory (where RDB file is saved)
dir /data

# AOF (Append-Only File) persistence - journal of all write operations
# Provides better durability than RDB
appendonly yes

# AOF file name
appendfilename "appendonly.aof"

# AOF sync policy:
# - always: fsync after every write operation (safest, slowest)
# - everysec: fsync every second (balanced - DEFAULT)
# - no: let OS decide (fastest, least safe)
appendfsync everysec

# When AOF rewrite is in progress, don't fsync
no-appendfsync-on-rewrite no

# Auto-rewrite AOF when it grows to 64mb
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load corrupted AOF when server starts
aof-load-truncated yes

# Mix RDB and AOF? (redis 7+)
aof-use-rdb-preamble yes

# ============================================================================
# REPLICATION (optional for distributed setup)
# ============================================================================

# Leave empty for standalone (no replication)
# replconf listen-port 6379

# ============================================================================
# CLUSTER (not needed for single-node email client)
# ============================================================================

# cluster-enabled no

# ============================================================================
# SLOW LOG
# ============================================================================

# Log queries slower than specified microseconds (0 = disabled)
slowlog-log-slower-than 10000

# Maximum number of slow log entries
slowlog-max-len 128

# ============================================================================
# MONITORING & STATS
# ============================================================================

# Monitor all commands (can impact performance)
# monitor

# ============================================================================
# CLIENTS
# ============================================================================

# Max number of connected clients
# maxclients 10000

# ============================================================================
# KEYSPACE NOTIFICATIONS
# ============================================================================

# Enable keyspace notifications (for pub/sub)
# notify-keyspace-events "Ex"

# ============================================================================
# ADVANCED CONFIG
# ============================================================================

# Hash table settings
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List settings
list-max-ziplist-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog settings
hll-sparse-max-bytes 3000

# Stream settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Frequency of active key expiration checks (1-25, default 10)
hz 10

# ============================================================================
# CELERY-SPECIFIC OPTIMIZATIONS
# ============================================================================

# Celery broker configuration recommendations:
# - Use database 0 for tasks and results
# - Use database 1 for job metadata (optional)
# - Keep aof and rdb backup enabled for durability
# - Memory limit ensures no runaway growth
# - LRU eviction allows graceful degradation under load

# Task timeout configuration (in Celery app, not Redis)
# This is configured in services/email_service/celery_app.py
