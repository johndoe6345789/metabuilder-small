{
  "name": "Password Change Workflow",
  "active": false,
  "nodes": [
    {
      "id": "validate_context",
      "name": "Validate Context",
      "type": "metabuilder.validate",
      "typeVersion": 1,
      "position": [
        100,
        100
      ],
      "parameters": {
        "input": "{{ $context.user.id }}",
        "operation": "validate",
        "validator": "required"
      }
    },
    {
      "id": "validate_input",
      "name": "Validate Input",
      "type": "metabuilder.validate",
      "typeVersion": 1,
      "position": [
        400,
        100
      ],
      "parameters": {
        "input": "{{ $json }}",
        "operation": "validate",
        "rules": {
          "currentPassword": "required|string",
          "newPassword": "required|string|minLength:8|different:currentPassword",
          "confirmPassword": "required|string|same:newPassword"
        }
      }
    },
    {
      "id": "fetch_user",
      "name": "Fetch User",
      "type": "metabuilder.database",
      "typeVersion": 1,
      "position": [
        700,
        100
      ],
      "parameters": {
        "filter": {
          "id": "{{ $context.user.id }}",
          "tenantId": "{{ $context.tenantId }}"
        },
        "operation": "database_read",
        "entity": "User"
      }
    },
    {
      "id": "verify_current_password",
      "name": "Verify Current Password",
      "type": "metabuilder.operation",
      "typeVersion": 1,
      "position": [
        100,
        300
      ],
      "parameters": {
        "input": "{{ $json.currentPassword }}",
        "operation": "bcrypt_compare",
        "hash": "{{ $steps.fetch_user.output.passwordHash }}"
      }
    },
    {
      "id": "check_password_correct",
      "name": "Check Password Correct",
      "type": "metabuilder.condition",
      "typeVersion": 1,
      "position": [
        400,
        300
      ],
      "parameters": {
        "condition": "{{ $steps.verify_current_password.output === true }}",
        "operation": "condition"
      }
    },
    {
      "id": "hash_new_password",
      "name": "Hash New Password",
      "type": "metabuilder.operation",
      "typeVersion": 1,
      "position": [
        700,
        300
      ],
      "parameters": {
        "input": "{{ $json.newPassword }}",
        "operation": "bcrypt_hash",
        "rounds": 12
      }
    },
    {
      "id": "update_password",
      "name": "Update Password",
      "type": "metabuilder.database",
      "typeVersion": 1,
      "position": [
        100,
        500
      ],
      "parameters": {
        "filter": {
          "id": "{{ $context.user.id }}"
        },
        "data": {
          "passwordHash": "{{ $steps.hash_new_password.output }}",
          "passwordChangedAt": "{{ new Date().toISOString() }}"
        },
        "operation": "database_update",
        "entity": "User"
      }
    },
    {
      "id": "invalidate_sessions",
      "name": "Invalidate Sessions",
      "type": "metabuilder.operation",
      "typeVersion": 1,
      "position": [
        400,
        500
      ],
      "parameters": {
        "filter": {
          "userId": "{{ $context.user.id }}",
          "id": {
            "$ne": "{{ $context.sessionId }}"
          }
        },
        "operation": "database_delete_many",
        "entity": "Session"
      }
    },
    {
      "id": "send_confirmation_email",
      "name": "Send Confirmation Email",
      "type": "metabuilder.operation",
      "typeVersion": 1,
      "position": [
        700,
        500
      ],
      "parameters": {
        "data": {
          "displayName": "{{ $steps.fetch_user.output.displayName }}",
          "timestamp": "{{ new Date().toISOString() }}"
        },
        "operation": "email_send",
        "to": "{{ $steps.fetch_user.output.email }}",
        "subject": "Your password has been changed",
        "template": "password_changed"
      }
    },
    {
      "id": "emit_event",
      "name": "Emit Event",
      "type": "metabuilder.action",
      "typeVersion": 1,
      "position": [
        100,
        700
      ],
      "parameters": {
        "data": {
          "timestamp": "{{ new Date().toISOString() }}"
        },
        "action": "emit_event",
        "event": "password_changed",
        "channel": "{{ 'user:' + $context.user.id }}"
      }
    },
    {
      "id": "return_success",
      "name": "Return Success",
      "type": "metabuilder.action",
      "typeVersion": 1,
      "position": [
        400,
        700
      ],
      "parameters": {
        "action": "http_response",
        "status": 200,
        "body": {
          "message": "Password changed successfully. All other sessions have been invalidated for security."
        }
      }
    }
  ],
  "connections": {
    "validate_context": {
      "main": [
        [
          {
            "node": "validate_input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validate_input": {
      "main": [
        [
          {
            "node": "fetch_user",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch_user": {
      "main": [
        [
          {
            "node": "verify_current_password",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verify_current_password": {
      "main": [
        [
          {
            "node": "check_password_correct",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_password_correct": {
      "main": [
        [
          {
            "node": "hash_new_password",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "hash_new_password": {
      "main": [
        [
          {
            "node": "update_password",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update_password": {
      "main": [
        [
          {
            "node": "invalidate_sessions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "invalidate_sessions": {
      "main": [
        [
          {
            "node": "send_confirmation_email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send_confirmation_email": {
      "main": [
        [
          {
            "node": "emit_event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "emit_event": {
      "main": [
        [
          {
            "node": "return_success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "staticData": {},
  "meta": {},
  "settings": {
    "timezone": "UTC",
    "executionTimeout": 3600,
    "saveExecutionProgress": true,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "id": "workflow_password_change_workflow",
  "version": "3.0.0",
  "tenantId": "${TENANT_ID}"
}