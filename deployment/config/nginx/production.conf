user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
  worker_connections 1024;
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent"';

  access_log /var/log/nginx/access.log main;

  sendfile on;
  tcp_nopush on;
  keepalive_timeout 65;
  client_max_body_size 50M;

  gzip on;
  gzip_vary on;
  gzip_min_length 1000;
  gzip_comp_level 6;
  gzip_types text/plain text/css text/xml text/javascript
             application/json application/javascript application/xml
             image/svg+xml;

  # Shared proxy settings
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # Map Referer header to the correct Next.js upstream for root-level
  # __nextjs requests (fonts, stack-frames, etc.) that lack the app prefix.
  map $http_referer $nextjs_upstream {
    default              codegen;
    "~*/codegen"         codegen;
    "~*/pastebin"        pastebin;
    "~*/workflowui"      workflowui;
    "~*/app"             frontend-app;
    "~*/postgres"        postgres-dashboard;
    "~*/emailclient"     emailclient-app;
  }

  server {
    listen 80;
    server_name _;
    server_tokens off;

    # Docker DNS resolver — allows nginx to start even if backends are down
    resolver 127.0.0.11 valid=10s ipv6=off;

    # ================================================================
    # Health check
    # ================================================================
    location /health {
      access_log off;
      return 200 '{"status":"healthy"}';
      add_header Content-Type application/json;
    }

    # ================================================================
    # Welcome portal (static HTML)
    # ================================================================
    location = / {
      root /usr/share/nginx/portal;
      try_files /index.html =404;
    }

    location /portal/ {
      alias /usr/share/nginx/portal/;
    }

    # ================================================================
    # Web Applications
    # ================================================================

    # WorkflowUI - Visual workflow editor
    location /workflowui {
      set $upstream_workflowui workflowui;
      proxy_pass http://$upstream_workflowui:3000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # CodeForge IDE (Next.js with basePath: '/codegen')
    location /codegen {
      set $upstream_codegen codegen;
      proxy_pass http://$upstream_codegen:3000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # Pastebin
    location /pastebin {
      set $upstream_pastebin pastebin;
      proxy_pass http://$upstream_pastebin:3000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # Postgres Dashboard
    location /postgres {
      set $upstream_postgres postgres-dashboard;
      proxy_pass http://$upstream_postgres:3000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # Email Client
    location /emailclient {
      set $upstream_emailclient emailclient-app;
      proxy_pass http://$upstream_emailclient:3000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # Exploded Diagrams
    location /diagrams {
      set $upstream_diagrams exploded-diagrams;
      proxy_pass http://$upstream_diagrams:3000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # Storybook (built with vite base: '/storybook/' — proxy as-is, no rewrite)
    location /storybook/ {
      set $upstream_storybook storybook;
      proxy_pass http://$upstream_storybook:3000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
    location = /storybook {
      return 301 /storybook/;
    }

    # Frontend App
    location /app {
      set $upstream_app frontend-app;
      proxy_pass http://$upstream_app:3000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # ================================================================
    # Administration Tools
    # ================================================================

    # phpMyAdmin - MySQL admin
    location /phpmyadmin/ {
      set $upstream_phpmyadmin phpmyadmin;
      proxy_pass http://$upstream_phpmyadmin:80/;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_buffering off;
    }

    # Mongo Express - MongoDB admin
    # ME_CONFIG_SITE_BASEURL=/mongo-express means it expects the prefix in requests
    location /mongo-express/ {
      set $upstream_mongoexpress mongo-express;
      proxy_pass http://$upstream_mongoexpress:8081/mongo-express/;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_buffering off;
    }

    # RedisInsight - Redis admin
    # RI_PROXY_PATH=/redis-insight means it expects the prefix in requests
    location /redis-insight/ {
      set $upstream_redisinsight redisinsight;
      proxy_pass http://$upstream_redisinsight:5540;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # Kibana - Elasticsearch admin
    # SERVER_BASEPATH=/kibana + SERVER_REWRITEBASEPATH=true handles path internally
    location /kibana/ {
      set $upstream_kibana kibana;
      proxy_pass http://$upstream_kibana:5601;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_buffering off;
    }

    # ================================================================
    # Backend APIs
    # ================================================================

    # Pastebin Flask Backend API — strips /pastebin-api/ prefix
    location /pastebin-api/ {
      set $upstream_pastebin_backend pastebin-backend;
      rewrite ^/pastebin-api/(.*)$ /$1 break;
      proxy_pass http://$upstream_pastebin_backend:5000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # DBAL API via Next.js proxy convention (/api/dbal/{tenant}/{pkg}/{entity})
    # Strips /api/dbal/ prefix so DBAL server receives /{tenant}/{pkg}/{entity}
    location /api/dbal/ {
      set $upstream_dbal dbal;
      rewrite ^/api/dbal/(.*)$ /$1 break;
      proxy_pass http://$upstream_dbal:8080;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # DBAL API direct (/api/{tenant}/{pkg}/{entity} or /api/health etc.)
    location /api/ {
      set $upstream_dbal dbal;
      rewrite ^/api/(.*)$ /$1 break;
      proxy_pass http://$upstream_dbal:8080;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Email Service API — strip /email-api prefix
    location /email-api/ {
      set $upstream_email email-service;
      rewrite ^/email-api/(.*)$ /$1 break;
      proxy_pass http://$upstream_email:5000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ================================================================
    # Next.js internal paths (fonts, stack-frames, HMR)
    # Next.js emits requests to /__nextjs_* at the root path (without
    # the app basePath prefix). Use the Referer header to route to the
    # correct upstream; falls back to codegen if Referer is absent.
    # ================================================================
    location /__nextjs {
      proxy_pass http://$nextjs_upstream:3000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    # ================================================================
    # Security
    # ================================================================

    # Hide dotfiles
    location ~ /\. {
      deny all;
      access_log off;
    }

    # Security headers
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
  }
}
