# Local Nexus Registry — stand-in for GHCR during local development.
#
# Ports:
#   8091  →  Nexus web UI  (admin / nexus)
#   5050  →  Docker hosted repository (push + pull)
#
# Prerequisites — Docker Desktop must trust the insecure local registry:
#   Docker Desktop → Settings → Docker Engine → add to "insecure-registries":
#     "insecure-registries": ["localhost:5050"]
#   Then restart Docker Desktop.
#
# Note: Nexus ships amd64-only. On Apple Silicon it runs via Rosetta (works fine).
#
# Usage:
#   docker compose -f docker-compose.nexus.yml up -d
#   # Wait ~2 min for nexus-init to finish, then:
#   ./push-to-nexus.sh
#   # Use localhost:5050 in place of ghcr.io when running act:
#   act push -j schema-check --artifact-server-path /tmp/act-artifacts --env REGISTRY=localhost:5050

services:
  nexus:
    image: sonatype/nexus3:3.75.0
    platform: linux/amd64   # Nexus has no ARM64 image; runs via Rosetta on Apple Silicon
    container_name: nexus-registry
    restart: unless-stopped
    ports:
      - "8091:8081"   # Web UI + REST API (8081-8084 reserved by Docker Desktop)
      - "5050:5050"   # Docker hosted repository
    volumes:
      - nexus-data:/nexus-data
    environment:
      INSTALL4J_ADD_VM_PARAMS: "-Xms1g -Xmx1g -XX:MaxDirectMemorySize=1g"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8081/service/rest/v1/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 15
      start_period: 120s
    networks:
      - nexus-net

  nexus-init:
    image: alpine:3.19
    container_name: nexus-init
    depends_on:
      nexus:
        condition: service_healthy
    volumes:
      - nexus-data:/nexus-data:ro
      - ./nexus-init.sh:/nexus-init.sh:ro
    entrypoint: ["/bin/sh", "-c", "apk add --no-cache curl -q && sh /nexus-init.sh"]
    environment:
      NEXUS_URL: "http://nexus:8081"
      NEXUS_ADMIN_NEW_PASS: "nexus"
      DOCKER_REPO_PORT: "5050"
    restart: "no"
    networks:
      - nexus-net

volumes:
  nexus-data:
    name: nexus-data

networks:
  nexus-net:
    name: nexus-net
